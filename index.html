<!DOCTYPE html>
<html>
  <head>
    <title>Canvas Gallery</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>

  <body>
    <div id="app">
      <div id="image">
        <img id="current-image" height="1080" width="1920" />
        <canvas height="1080" width="1920">
          This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
      </div>
      <div id="content">
        <div class="flex-space-inbetween">
          <span id="current-image-name"></span>
        </div>
        <div class="right">
          <input
            type="file"
            id="selectedFile"
            accept="image/*"
            style="display: none"
          />
          <input
            type="button"
            value="Upload New Image"
            onclick="document.getElementById('selectedFile').click();"
          />
        </div>
        <ul id="tags"></ul>
      </div>
    </div>
    <script>
      const MAX_WIDTH = 1920;
      const MAX_HEIGHT = 1080;
      window.addEventListener("load", () => {
        const canvas = document.querySelector("canvas");
        const context = canvas.getContext("2d");
        let imageWidth = canvas.width;
        let imageHeight = canvas.height;
        document
          .querySelector("#selectedFile")
          .addEventListener("change", (e) => {
            e.preventDefault();
            const reader = new FileReader();
            reader.readAsDataURL(e.target.files[0]);
            reader.onload = () => {
              const image = document.getElementById("current-image");
              image.src = reader.result;
              image.onload = () => {
                imageWidth = image.width;
                imageHeight = image.height;

                // Change the resizing logic
                if (width > height) {
                  if (width > MAX_WIDTH) {
                    height = height * (MAX_WIDTH / width);
                    width = MAX_WIDTH;
                  }
                } else {
                  if (height > MAX_HEIGHT) {
                    width = width * (MAX_HEIGHT / height);
                    height = MAX_HEIGHT;
                  }
                }
                canvas.width = imageWidth;
                canvas.height = imageHeight;
                image.width = imageWidth;
                image.height = imageHeight;
                document.querySelector("#current-image-name").textContent =
                  e.target.files[0].name;
              };
            };
          });
        let isDrawing = false;
        let start = { x: 0, y: 0 };
        function getMousePos(canvas, e) {
          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY,
          };
        }
        function startPosition(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("starting");
          isDrawing = true;
          start = getMousePos(canvas, e);
        }
        function endPosition(e) {
          e.preventDefault();
          e.stopPropagation();
          isDrawing = false;

          const end = getMousePos(canvas, e);
          const width = end.x - start.x;
          const height = end.y - start.y;
          const list = document.querySelector("#tags");
          let tag = prompt("Please type the tag text", "your tag");
          context.clearRect(0, 0, imageWidth, imageHeight);
          const item = document.createElement("li");
          item.textContent = tag;
          list.appendChild(item);

          var svgns = "http://www.w3.org/2000/svg";
          const svg = document.createElementNS(svgns, "svg");
          svg.setAttribute(
            "style",
            `position: absolute;height: ${imageHeight}px;width:${imageWidth}px;`
          );
          const g = document.createElementNS(svgns, "g");
          g.setAttribute(
            "style",
            `height: ${imageHeight}px;width:${imageWidth}px;`
          );
          const rect = document.createElementNS(svgns, "rect");
          rect.setAttribute("x", start.x);
          rect.setAttribute("y", start.y);
          rect.setAttribute("height", height);
          rect.setAttribute("width", width);
          rect.setAttribute("stroke", "#B1B9C0");
          rect.setAttribute("fill", "none");
          rect.setAttribute("stroke-width", "1px");
          const text = document.createElementNS(svgns, "text");
          text.setAttribute("x", start.x + 2);
          text.setAttribute("y", start.y + 16);
          text.setAttribute("font-size", 14);
          text.setAttribute("fill", "#B1B9C0");
          text.textContent = tag;
          g.appendChild(rect);
          g.appendChild(text);
          svg.appendChild(g);
          const parent = document.getElementById("image");
          parent.insertBefore(svg, document.querySelector("canvas"));
        }
        function draw(e) {
          e.preventDefault();
          e.stopPropagation();
          if (!isDrawing || !canvas.getContext) return;
          context.clearRect(0, 0, canvas.width, canvas.height);
          const pos = getMousePos(canvas, e);
          const width = pos.x - start.x;
          const height = pos.y - start.y;
          context.beginPath();
          context.fillStyle = "rgba(198,230,255, 0.4)";
          context.lineWidth = 1;
          context.strokeStyle = "#047DFF";
          context.rect(start.x, start.y, width, height);
          context.stroke();
          context.fill();
        }

        canvas.addEventListener("mousedown", startPosition);
        canvas.addEventListener("mouseup", endPosition);
        canvas.addEventListener("mousemove", draw);
      });
    </script>
  </body>
</html>
