<!DOCTYPE html>
<html>
  <head>
    <title>Canvas Gallery</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>

  <body>
    <div id="app">
      <div id="image">
        <img id="current-image" height="1080" width="1920" />
        <canvas height="1080" width="1920">
          This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
      </div>
      <div id="content">
        <div class="flex-space-inbetween">
          <span id="current-image-name"></span>
          <div id="current-image-info" class="right">
            <button id="back-button">Back</button>
            <span id="current-index"></span>
            <span>of</span>
            <span id="image-count"></span>
            <button id="next-button">Next</button>
          </div>
        </div>
        <div class="right">
          <button id="delete-image-button">Delete</button>
          <input
            type="file"
            id="selectedFile"
            accept="image/*"
            style="display: none"
          />
          <input
            type="button"
            value="Upload New Image"
            onclick="document.getElementById('selectedFile').click();"
          />
        </div>
        <ul id="tags"></ul>
      </div>
    </div>
    <script>
      const IMAGES_KEY = "IMAGES_LIST";
      const MAX_WIDTH = 1920;
      const MAX_HEIGHT = 1080;

      window.addEventListener("load", () => {
        const canvas = document.querySelector("canvas");
        const context = canvas.getContext("2d");
        let imageWidth = canvas.width;
        let imageHeight = canvas.height;
        let isDrawing = false;
        let start = { x: 0, y: 0 };
        let currentImageName = "";
        let currentImageOrder = 0;
        let savedImageList = getImageListFromLocalStorage();

        function getImageListFromLocalStorage() {
          const storedImageList = localStorage.getItem(IMAGES_KEY);
          const list = JSON.parse(storedImageList);
          return Array.isArray(list) ? list : [];
        }
        function getImageFromLocalStorage() {
          if (currentImageOrder >= savedImageList.length) {
            return undefined;
          }
          const name = savedImageList[currentImageOrder];
          const src = localStorage.getItem(name);
          if (src) {
            return { name, src };
          }
          return undefined;
        }
        function saveImageToLocalStorage(name, src) {
          savedImageList.unshift(name);
          localStorage.setItem(IMAGES_KEY, JSON.stringify(savedImageList));
          localStorage.setItem(name, src);
        }
        function loadImage(id, src) {
          const image = document.getElementById("current-image");
          image.src = src;
          const imageName = id;
          image.onload = () => {
            imageWidth = image.width;
            imageHeight = image.height;

            // Change the resizing logic
            if (imageWidth > imageHeight) {
              if (imageWidth > MAX_WIDTH) {
                imageHeight = imageHeight * (MAX_WIDTH / imageWidth);
                imageWidth = MAX_WIDTH;
              }
            } else {
              if (imageHeight > MAX_HEIGHT) {
                imageWidth = imageWidth * (MAX_HEIGHT / imageHeight);
                imageHeight = MAX_HEIGHT;
              }
            }
            const canvas = document.querySelector("canvas");
            canvas.width = imageWidth;
            canvas.height = imageHeight;
            image.width = imageWidth;
            image.height = imageHeight;
            document.querySelector("#current-image-name").textContent =
              imageName;
          };
        }
        function refreshImage() {
          const savedImage = getImageFromLocalStorage();
          if (savedImage) {
            loadImage(savedImage.name, savedImage.src);
            currentImageName = savedImage.name;
          }
        }
        function getMousePos(canvas, e) {
          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY,
          };
        }
        function startPosition(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("starting");
          isDrawing = true;
          start = getMousePos(canvas, e);
        }
        function endPosition(e) {
          e.preventDefault();
          e.stopPropagation();
          isDrawing = false;

          const end = getMousePos(canvas, e);
          const width = end.x - start.x;
          const height = end.y - start.y;
          const list = document.querySelector("#tags");
          let tag = prompt("Please type the tag text", "your tag");
          context.clearRect(0, 0, imageWidth, imageHeight);
          const item = document.createElement("li");
          item.textContent = tag;
          list.appendChild(item);

          var svgns = "http://www.w3.org/2000/svg";
          const svg = document.createElementNS(svgns, "svg");
          svg.setAttribute(
            "style",
            `position: absolute;height: ${imageHeight}px;width:${imageWidth}px;`
          );
          const g = document.createElementNS(svgns, "g");
          g.setAttribute(
            "style",
            `height: ${imageHeight}px;width:${imageWidth}px;`
          );
          const rect = document.createElementNS(svgns, "rect");
          rect.setAttribute("x", start.x);
          rect.setAttribute("y", start.y);
          rect.setAttribute("height", height);
          rect.setAttribute("width", width);
          rect.setAttribute("stroke", "#B1B9C0");
          rect.setAttribute("fill", "none");
          rect.setAttribute("stroke-width", "1px");
          const text = document.createElementNS(svgns, "text");
          text.setAttribute("x", start.x + 2);
          text.setAttribute("y", start.y + 16);
          text.setAttribute("font-size", 14);
          text.setAttribute("fill", "#B1B9C0");
          text.textContent = tag;
          g.appendChild(rect);
          g.appendChild(text);
          svg.appendChild(g);
          const parent = document.getElementById("image");
          parent.insertBefore(svg, document.querySelector("canvas"));
        }
        function draw(e) {
          e.preventDefault();
          e.stopPropagation();
          if (!isDrawing || !canvas.getContext) return;
          context.clearRect(0, 0, canvas.width, canvas.height);
          const pos = getMousePos(canvas, e);
          const width = pos.x - start.x;
          const height = pos.y - start.y;
          context.beginPath();
          context.fillStyle = "rgba(198,230,255, 0.4)";
          context.lineWidth = 1;
          context.strokeStyle = "#047DFF";
          context.rect(start.x, start.y, width, height);
          context.stroke();
          context.fill();
        }
        canvas.addEventListener("mousedown", startPosition);
        canvas.addEventListener("mouseup", endPosition);
        canvas.addEventListener("mousemove", draw);
        document
          .querySelector("#selectedFile")
          .addEventListener("change", (e) => {
            e.preventDefault();
            const reader = new FileReader();
            const file = e.target.files[0]; // First file for now
            reader.readAsDataURL(file);
            const imageName = file.name;

            reader.onload = () => {
              loadImage(imageName, reader.result);
              saveImageToLocalStorage(imageName, reader.result);
              if (savedImageList.length === 2) {
                const imageInfoElement =
                  document.getElementById("current-image-info");
                imageInfoElement.style.display = "block";
                document.getElementById("current-index").textContent =
                  currentImageOrder + 1;
                document.getElementById("image-count").textContent =
                  savedImageList.length;
              }
              if (savedImageList.length === 1) {
                const deleteImageButton = document.getElementById(
                  "delete-image-button"
                );
                deleteImageButton.style.display = "inline";
                const imageNameElement =
                  document.getElementById("current-image-name");
                imageNameElement.style.display = "inline";
              }
            };
            refreshImage();
          });
        document
          .getElementById("delete-image-button")
          .addEventListener("click", (e) => {
            if (currentImageName) {
              savedImageList = savedImageList.filter(
                (i) => i !== currentImageName
              );
              localStorage.setItem(IMAGES_KEY, JSON.stringify(savedImageList));
              localStorage.removeItem(currentImageName);

              if (savedImageList.length === 0) {
                const imageInfoElement =
                  document.getElementById("current-image-info");
                if (imageInfoElement) {
                  imageInfoElement.style.display = "none";
                }
                const deleteImageButton = document.getElementById(
                  "delete-image-button"
                );
                deleteImageButton.style.display = "none";
                document
                  .getElementById("current-image")
                  .setAttribute("src", "");
              } else {
                const imageCountElement =
                  document.getElementById("image-count");
                imageCountElement.textContent = savedImageList.length;
                refreshImage();
              }
            }
          });
        document
          .getElementById("back-button")
          .addEventListener("click", (e) => {
            currentImageOrder =
              currentImageOrder === 0
                ? savedImageList.length - 1
                : currentImageOrder - 1;
            refreshImage();
            document.getElementById("current-index").textContent =
              currentImageOrder + 1;
          });
        document
          .getElementById("next-button")
          .addEventListener("click", (e) => {
            currentImageOrder =
              currentImageOrder === savedImageList.length - 1
                ? 0
                : currentImageOrder + 1;
            refreshImage();
            document.getElementById("current-index").textContent =
              currentImageOrder + 1;
          });

        // Initial loading
        if (savedImageList.length > 1) {
          const imageInfoElement =
            document.getElementById("current-image-info");
          imageInfoElement.style.display = "block";

          document.getElementById("current-index").textContent =
            currentImageOrder + 1;
          document.getElementById("image-count").textContent =
            savedImageList.length;
        }
        if (savedImageList.length > 0) {
          const imageNameElement =
            document.getElementById("current-image-name");
          imageNameElement.style.display = "inline";
          const deleteImageButton = document.getElementById(
            "delete-image-button"
          );
          deleteImageButton.style.display = "inline";
          refreshImage();
        }
      });
    </script>
  </body>
</html>
